
use 'libs/tests/common.baabnq';

"library has to run, to define consts
lab fInit;
static 1 _pTst; "test ptr
use 'libs/float.baabnq';
return;


"check constants
lab TestFloats::Const;
    sub fInit;

    "shared consts
    jump fail ~ _upper16 != 65280;
    jump fail ~ _posNaN != 16256;
    jump fail ~ _FpZero != 16384;    

    "system consts
    jump fail ~ _MANTISSA_SIZE != 8;
    jump fail ~ _EXPONENT_SIZE != 8;
    jump fail ~ _SIGN_SIZE     != 15;

    jump fail ~ _MANTISSA_MASK != 127;
    jump fail ~ _EXPONENT_MASK != 255;
    jump fail ~ _SIGN_MASK     != 32768;

    jump fail ~ _MIN_SIGNED_CHAR != 128;

    jump succ;

lab TestFloats::GetMantissa;
    sub fInit;
    
    "msb is implied to save space    
    push 0;
    sub Floats::GetMantissa;
    pull _v;
    jump fail ~ _v != 128;

    push 127;
    sub Floats::GetMantissa;
    pull _v;
    jump fail ~ _v != 128 | 127;
    
    jump succ;


lab TestFloats::GetExponent;
    sub fInit;
    
    "zero should be zero
    push 0 << 7; "<< 7 for symmetry
    sub Floats::GetExponent;
    pull _v;
    jump fail ~ _v != 0;

    "!zero should be !zero (>> 7)
    push 255 << 7;
    sub Floats::GetExponent;
    pull _v;
    jump fail ~ _v != 255;
    
    jump succ;

lab TestFloats::SetMantissa;
    sub fInit;

    "!zero against zero
    put (0 - 1) -> _pTst;
    push _pTst;
    push 0;
    sub Floats::SetMantissa;
    put _v <- _pTst;
    jump fail ~ _v != ((1 << 15) | (255 << 7));

    "other way round
    put 0 -> _pTst;
    push _pTst;
    push (0 - 1); "maxint will be capped by _MANTISSA_MASK
    sub Floats::SetMantissa;
    put _v <- _pTst;
    jump fail ~ _v != 0 | (127 << 0);
    

    jump succ;


lab TestFloats::SetExponent;
    sub fInit;

    "!zero against zero
    put (0 - 1) -> _pTst;
    push _pTst;
    push 0;
    sub Floats::SetExponent;
    put _v <- _pTst;
    jump fail ~ _v != ((1 << 15) | (127 << 0));

    "other way round
    put 0 -> _pTst;
    push _pTst;
    push (0 - 1); "maxint will be capped by _EXPONENT_MASK
    sub Floats::SetExponent;
    put _v <- _pTst;
    jump fail ~ _v != 0 | (255 << 7);
    

    jump succ;

    